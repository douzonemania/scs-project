<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="order">
	<select id="findByDate" parameterType="map" resultType="ordersettlevo">
	<choose>
		<when test="startDate  =='' and endDate == '' ">
			<![CDATA[
				select item.no as 'no', member.id as 'id', DATE_FORMAT(shop_order.reg_date, '%Y-%m-%d %T') as 'regDate', truncate(sum(item.now_price -(item.now_price * sale / 100)),0) as 'purchasePrice', truncate((sum(item.now_price -(item.now_price * sale / 100)) - sum(item.sup_price)),0) as 'marginPrice', item.sale
				  from ${db}.item, ${db}.stock, ${db}.order_item, ${db}.shop_order, ${db}.member
				 where item.no = stock.item_no 
				   and stock.no = order_item.stock_no
				   and order_item.order_no = shop_order.no
				   and shop_order.member_no = member.no
				   group by 1
				   limit ${size} offset #{offset}
			]]>
		</when>
		<otherwise>
			<![CDATA[
				select item.no as 'no', member.id as 'id', DATE_FORMAT(shop_order.reg_date, '%Y-%m-%d %T') as 'regDate', truncate(sum(item.now_price -(item.now_price * sale / 100)),0) as 'purchasePrice', truncate((sum(item.now_price -(item.now_price * sale / 100)) - sum(item.sup_price)),0) as 'marginPrice', item.sale
				  from ${db}.item, ${db}.stock, ${db}.order_item, ${db}.shop_order, ${db}.member
				 where item.no = stock.item_no 
				   and stock.no = order_item.stock_no
				   and order_item.order_no = shop_order.no
				   and shop_order.member_no = member.no
				  and shop_order.reg_date >= #{startDate } and shop_order.reg_date <= #{endDate }
				 group by 1
				 limit ${size} offset #{offset}
			]]>
		</otherwise>
	</choose>
	</select>
	
	<select id="listCount" parameterType="map" resultType="int">
			<choose>
				<when test='startDate  == "" and endDate == "" '>
					<![CDATA[
						select count(*)
						  from ${db}.item, ${db}.stock, ${db}.order_item, ${db}.shop_order, ${db}.member
						 where item.no = stock.item_no 
						   and stock.no = order_item.stock_no
						   and order_item.order_no = shop_order.no
						   and shop_order.member_no = member.no
					]]>
				</when>
				<otherwise>
					<![CDATA[
						select count(*)
						  from ${db}.item, ${db}.stock, ${db}.order_item, ${db}.shop_order, ${db}.member
						 where item.no = stock.item_no 
						   and stock.no = order_item.stock_no
						   and order_item.order_no = shop_order.no
						   and shop_order.member_no = member.no
						   and shop_order.reg_date >= #{startDate } and shop_order.reg_date <= #{endDate }
						   
					]]>
				</otherwise>
			</choose>
			
	</select>
	
	<select id="findTotalPrice" parameterType="map" resultType="int">
	<choose>
		<when test="startDate  =='' and endDate == '' ">
			<![CDATA[
				select truncate(sum(item.now_price -(item.now_price * sale / 100)),0) as 'totalPrice'
				  from ${db}.item, ${db}.stock, ${db}.order_item, ${db}.shop_order, ${db}.member
				 where item.no = stock.item_no 
				   and stock.no = order_item.stock_no
				   and order_item.order_no = shop_order.no
				   and shop_order.member_no = member.no
			]]>
		</when>
		<otherwise>
			<![CDATA[
				select truncate(sum(item.now_price -(item.now_price * sale / 100)),0) as 'totalPrice'
				  from ${db}.item, ${db}.stock, ${db}.order_item, ${db}.shop_order, ${db}.member
				 where item.no = stock.item_no 
				   and stock.no = order_item.stock_no
				   and order_item.order_no = shop_order.no
				   and shop_order.member_no = member.no
				   and shop_order.reg_date >= #{startDate } and shop_order.reg_date <= #{endDate }
			]]>
		</otherwise>
	</choose>
	</select>
	
	<select id="findTotalMargin" parameterType="map" resultType="int">
	<choose>
		<when test="startDate  =='' and endDate == '' ">
			<![CDATA[
				select truncate((sum(item.now_price -(item.now_price * sale / 100)) - sum(item.sup_price)),0) as 'totalMargin'
				  from ${db}.item, ${db}.stock, ${db}.order_item, ${db}.shop_order, ${db}.member
				 where item.no = stock.item_no 
				   and stock.no = order_item.stock_no
				   and order_item.order_no = shop_order.no
				   and shop_order.member_no = member.no
			]]>
		</when>
		<otherwise>
			<![CDATA[
				select truncate((sum(item.now_price -(item.now_price * sale / 100)) - sum(item.sup_price)),0) as 'totalMargin'
				  from ${db}.item, ${db}.stock, ${db}.order_item, ${db}.shop_order, ${db}.member
				 where item.no = stock.item_no 
				   and stock.no = order_item.stock_no
				   and order_item.order_no = shop_order.no
				   and shop_order.member_no = member.no
				   and shop_order.reg_date >= #{startDate } and shop_order.reg_date <= #{endDate }
			]]>
		</otherwise>
	</choose>
	</select>

</mapper>